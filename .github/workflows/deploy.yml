name: Deploy to Mac mini

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for .env file
        run: |
          if [ ! -f .env ]; then
            echo "Warning: .env file not found. Please create one based on .env.example"
            echo "The bot may fail to start without proper configuration."
            exit 1
          fi
      
      - name: Validate environment configuration
        run: |
          source .env
          required_vars=("MATRIX_HOMESERVER" "MATRIX_USER_ID" "MATRIX_PASSWORD" "OPENROUTER_API_KEY")
          missing_vars=()
          
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "âŒ Missing required environment variables:"
            printf '   - %s\n' "${missing_vars[@]}"
            echo "ğŸ“ Please update your .env file"
            exit 1
          fi
          echo "âœ… Configuration validated successfully"
      
      - name: Stop existing services
        run: |
          echo "ğŸ›‘ Stopping existing services..."
          docker-compose down || true
          sleep 3
      
      - name: Build and deploy with Docker
        run: |
          echo "ğŸ—ï¸  Building Docker images..."
          docker-compose build
          
          echo "ğŸš€ Starting chatbot services..."
          docker-compose up -d
          
          echo "â³ Waiting for services to start..."
          sleep 10
      
      - name: Check deployment status
        run: |
          echo "ğŸ“Š Checking service status..."
          docker-compose ps
          
          echo "ğŸ” Checking if chatbot is healthy..."
          if docker-compose ps chatbot | grep -q "Up"; then
            echo "âœ… Chatbot service is running"
            echo "ğŸ“‹ Recent logs:"
            docker-compose logs --tail=20 chatbot
          else
            echo "âŒ Chatbot service failed to start"
            echo "ğŸ” Error logs:"
            docker-compose logs chatbot
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Control panel: http://localhost:8000"

